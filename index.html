<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web BLE Test</title>
</head>
<body>
    <!-- <form>
        <button>Connect with BLE device</button>
    </form> -->
    
    <button id="read">Connect with BLE device</button>
    <button id="start" disabled>Start</button>
    <button id="stop" disabled>Stop</button>
    <label id="val_label">Value</label>
    <div class="slidecontainer">
        <input type="range" min="1" max="100" value="50" class="slider" id="myRange">
      </div>
</body>
<script>
    var deviceName = "Hero BLE"
    var bleService = "0b0b1008-feed-dead-bee5-0be9b1091c50"             // BLE_UUID_REAL_TIME_SERVICE
    var bleCharacteristic = "0b0b201a-feed-dead-bee5-0be9b1091c50"      // BLE_UUID_RT_BUTTON_STATUS_CHAR
    var bluetoothDeviceDetected
    var gattCharacteristic

    document.querySelector("#read").addEventListener("click", function() {
        if (isWebBLEAvailable()) { read() }
    })

    document.querySelector("#start").addEventListener("click", function(event) {
        if (isWebBLEAvailable()) { start() }
    })

    document.querySelector("#stop").addEventListener("click", function(event) {
        if (isWebBLEAvailable()) { stop() }
    })

    function isWebBLEAvailable() {
        if (!navigator.bluetooth) {
            console.log("Web Bluetooth is not available!");
            return false;
        }
        return true;
    }

    function getDeviceInfo() {
        let options = {
            optionalServices: [bleService],
            filters: [
                { name: deviceName }
            ]
        }
        
        console.log("Requesting BLE device info...");
        return navigator.bluetooth.requestDevice(options).then(device => {
            bluetoothDeviceDetected = device;
        }).catch(error => {
            console.log("Request device error: " + error);
        })
    }

    function read() {
        return (bluetoothDeviceDetected ? Promise.resolve() : getDeviceInfo())
        .then(connectGATT)
        .then(_ => {
            console.log("Reading val...")
            return gattCharacteristic.readValue();
        })
        .catch(error => {
            console.log("Waiting to start reading..." + error)
        })
    }

    function connectGATT() {
        if(bluetoothDeviceDetected.gatt.connected && gattCharacteristic) {
            return Promise.resolve()
        }

        return bluetoothDeviceDetected.gatt.connect()
        .then(server => {
            console.log("Getting GATT Service...")
            return server.getPrimaryService(bleService)
        })
        .then(service => {
            console.log("Getting GATT Characteristic...")
            return service.getCharacteristic(bleCharacteristic)
        })
        .then(characteristic => {
            gattCharacteristic = characteristic;
            gattCharacteristic.addEventListener("characteristicvaluechanged", handleChangedValue)

            document.querySelector("#start").disabled = false;
            document.querySelector("#stop").disabled = true;
        })
    }

    function handleChangedValue(event) {
        let value = event.target.value.getUint8(0);
        var now = new Date();
        console.log("> " + now.getHours() + ":" + now.getMinutes() + ":" + now.getSeconds() + " Val is " + value)
        document.getElementById("val_label").innerHTML = value.toString()
    }
    
    function start() {
        gattCharacteristic.startNotifications()
        .then(_ => {
            console.log("Start reading...");
            document.querySelector("#start").disabled = true;
            document.querySelector("#stop").disabled = false;
        })
        .catch(error => {
            console.log("[ERROR] Start: " + error)
        })
    }

    function stop() {
        gattCharacteristic.stopNotifications()
        .then(_ => {
            console.log("Stop reading...");
            document.querySelector("#start").disabled = false;
            document.querySelector("#stop").disabled = true;
        })
        .catch(error => {
            console.log("[ERROR] Stop: " + error)
        })
    }
</script>

</html>